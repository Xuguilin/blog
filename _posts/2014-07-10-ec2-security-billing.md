---
layout: post
title: 如何高效使用亚马逊EC2之安全与成本控制 
---

{{ page.title }}
================

<p class="meta">2014/07/10 - 上海 By 徐桂林</p>

【本文为我在2014年07月发表于《程序员》杂志的一篇文章】


## 服务安全

安全是很多人对公有云服务的主要担心，尤其是把公司关键生产系统部署在公有云上。而且经常发生的安全事故也不断地加重大家对于这个方面的担心。个人觉得把安全问题和公有云直接等同确实有失偏颇，而且历史上发生的多次用户数据丢失、泄露事件其实与公有云没有直接关系。要解决安全问题，必须要真正把这个问题贯穿到整个产品和服务的生命周期（从系统需求到产品设计和线上运维整个流程中）。在公有云模式下，客户和AWS共同承担安全责任，AWS主要承担基础设施层的安全责任，包括基础设施的物理安全和基础服务安全（如基本网络攻击的防护等）。而客户需要在此基础上建立自己服务的安全策略（主要包括数据存储安全和数据传输安全两个方面）。作为公有云服务提供商，AWS给客户提供了很多好用的安全问题工具（如IAM、Security Group、MFA等）来帮助客户实现自己的安全策略。由于EC2是提供运算服务，和它相关的安全工具主要是帮助用户建立安全的数据传输通道。这里介绍其中的一些的常见技巧：

1）充分使用安全组（Security Group）策略。Security Group是AWS提供的端口防火墙策略设置工具，你可以指定EC2机器向外开放的端口及可以使用该端口的来源范围（可以是IP段，也可以是来自另外一个Security Group的EC2实例）。

- 正确设置安全组。图1（来自AWS Security最佳实践1）很好的解释了设置Security的最佳策略。如图所示，Web服务层仅会对整个互联网开放HTTP、HTTPS端口。而应用逻辑层则只接受来自Web服务层的请求（指定端口仅可接受来自拥有Web服务层Security Group的EC2实例）和来自公司开发和运维人员的请求（设置指定端口仅可接受来自公司的IP）。最后，数据层只能接受来自应用逻辑层的请求，这样只能通过应用逻辑层的服务器才能访问、操作你的后台数据。

- 正确管理安全组。由于一个EC2实例可以绑定多个安全组，可以利用这个功能简化整个安全组的管理工作。例如，可以把所有要设置的端口策略按照用途存入不同的安全组内（如SG-Web-Access, SG-App-Access，SG-Management, SG-Monitoring, SG-Logging等）。这样可以非常方便地知道端口目的，并且可以利用IAM设置对这些安全组的不同管理权限，从而更好的管理线上风险和避免误操作。 

![安全组图](/images/2014-07-10/security-group.png)

图1：AWS推荐的EC2 Security Group配置方式 

2）使用IAM Role来代替Account credentials。除了可以通过Console访问AWS外，AWS还提供API方式访问它的资源和服务。在用API访问AWS资源和服务时，需要使用Access key/security来做用户认证和授权。所以，妥善保护好你的账户Access key/security就尤为重要。在没有IAM role之前，用户一般要把这些信息Hard Coding到自己的代码或者放到配置信息中部署到EC2机器上，但是这就增加了泄露Access key/security的风险 (最近，AWS官方博客分享一个Access key/security被盗的真实例子2，用户为此损失了500美金)。简单来说，当启动一台EC2实例时，你可以指定该实例将扮演的IAM role（换句话说，就是它要访问的AWS资源），并在IAM中设置好该role需要的AWS资源权限。然后，AWS 会为该EC2实例动态产生一个拥有IAM role中指定权限的临时credential，于是这台EC2机器中的所有AWS API 调用都能自动使用该临时credential。和以前的IAM User相比较，IAM Role有多个好处：

- 可以避免Hard Coding你的credential
- AWS负责帮你产生临时的credential并会保证及时更新这个临时的credential。相比于以前需要经常手动rotate Account credentials要方便很多。
- 产生的临时credential只能在当前的EC2实例上使用，即使别人拿到了这个credential也无法在别的地方使用

IAM role带来的一个副作用就是无法直接在EC2以外的环境下开发、调试需要IAM role支持的程序。一个常见的解决方案就是利用不同编译配置，例如，Debug编译配置仍然直接Hard Coding你的credential，但在Release编译配置则采用IAM Role。

3）使用VPC（Virtual Private Cloud）代替传统的Classic模式。在推出VPC之前，所有的EC2实例都是直接和公网连接，并且每个实例都会有一个自动分配或者手动绑定的公网IP地址。这种模式在VPC推出后被命名为Classic模式。而在实际实践中并不需要让所有的实例都暴露在公网上，而且这样做会大大增加被攻击的风险。VPC服务则可以让你在公有云环境下构建私有网络并只让需要的服务实例连接到公网上。除了安全考量，VPC还有很多其他优势，你可以参考相关文档了解更多内容。一个好的消息是最新创建的AWS账号默认都是使用VPC的。 

## 服务监控

对于任何一个在线系统，服务监控都是必不可少的。在云计算环境中，服务监控不仅仅可以让你了解当前的系统运行情况，而且它还是很多其他服务（如Load Balancing，Auto Scaling等）的基础。为此，AWS提供了自己的监控服务：AWS Cloud Watch，它提供了大量的内建监控指标并已和其他AWS服务集成。使用AWS Cloud Watch监控EC2服务的典型场景如下：

- 监控EC2实例的当前负载及健康情况并及时发送报警信息。为你的EC2实例选择感兴趣的监控指标并设置Alarm的条件，然后结合AWS SNS（Simple Notification Service）就可以让系统Alarm被激活时及时发送Alert消息（通过邮件或者其他方式）

- 和其他服务结合使用。例如，使用Cloud Watch来支撑Auto Scaling策略动态调整的EC2服务容量，使用Cloud Watch来向ELB及时汇报EC2实例的健康状况等。

尽管Cloud Watch服务非常强大，并且和AWS其他服务做了很好集成，但是它并不是总能应对各种不同服务类型对于监控系统的各种不同要求（如实时性、全面性、智能型等）。所以在确定服务监控方案时，请先仔细明确需求。下面就监控系统常见需求给出一些常见的实践经验：

- 确定需要实时性还是近实时性监控。目前，AWS Cloud Watch提供两种类型的Monitoring，一种是免费的5分钟延时基本Monitoring，另外一种是需要额外收费的1分钟延时Detail Monitoring。这两种频率的监控机制应能够满足绝大部分系统的需求，你可能需要结合两种Monitoring来以最小的成本达到你的监控目标。

- 确定需要的监控指标。对于监控系统，全面的监控指标也是其重要考量。一个好的监控系统必须要能够覆盖到系统的各个主要方面。目前，Cloud Watch提供了很多内建的EC2监控指标（不仅仅包括EC2监控指标），但是，它还是欠缺一些常见的监控指标，例如内存的使用情况、交换页的频率等。当然，用户可以给EC2 Cloud Watch添加这些自定义监控指标，只不过需要自己实现EC2实例上的Agent来采集这些指标并通过API发送给Cloud Watch。

- 支持必要的智能处理。监控系统，就中文来说，它包括“监”和“控”两个方面的意思。让监控系统发送系统异常通知（如Alert Email）是个不错是实践。但是，很多时候我们还希望监控系统能够承担部分的“控”的工作，以减轻运维团队的压力。而且，良好设计的控制策略在云计算环境中可能并不复杂，甚至已经存在。例如Auto Scaling机制就是利用监控系统的监控指标结合用户自定义策略来控制你的EC2服务容量。目前，AWS Cloud Watch还没有提供灵活的Auto Healing框架，但我们在设计监控方案是应该考虑这个需求。幸运的是，已经有很多基于AWS或者传统监控平台都已经有这样的功能。

- 支持直观的监控状态展示。任何一套监控系统，没有好的展示都会事倍功半。AWS Cloud Watch提供基本展示功能，但是它欠缺Dashboard（例如，集中展示多个监控指标，显示多个指标间的相关性等）。所以，绝大多数情况下，用户需要自己做（利用Cloud Watch API）或者采用第三方方案。

- 及时保存历史数据：尽管Monitoring数据主要是为了监控系统的当前状态，但是保留监控数据的历史记录还是很有意义的。你可以拿它做后续的各种数据分析。目前Cloud Watch数据只保留14天的监控历史数据，所以记得及时备份你的Monitoring数据。

Cloud Watch非常强大，但如上所述，它也有挺多的局限。我们到底应该怎样选择自己的监控方案呢？。是否应该完全抛开Cloud Watch自己建立一套监控方案？这个当然是可以的（例如，你可以在系统中部署一套基于Nagios的系统），但个人不建议这么做，因为：

- 在AWS中，你是很难完全抛开Cloud Watch来只做自己的监控系统，因为很多其他的AWS服务还是需要Cloud Watch监控数据支持。如果你完全自己做监控系统，那还必须考虑到该系统和其他基于Cloud Watch的AWS服务交互。

- 在AWS中，Cloud Watch确实缺少一些关键的内建监控指标，但是Cloud Watch也有很多其独有的内建监控指标（例如EBS的IO监控指标），而这些指标很多可能只有Cloud Watch才能够很好地Monitoring，你的监控系统对此就无能为力。

- 在AWS中，Cloud Watch缺少智能处理和状态展示功能（OpsWork部分增强了这些功能），这个可能是你需要重点考虑的。幸运的是，Cloud Watch提供了丰富的API让我们可以基于它容易地开发出相应的功能。

- Cloud Watch是个高可用、便宜的服务。如果你不需要太实时的服务，它都完全免费。这样，它还能节省很多开发、部署监控系统的成本。

所以，一个基于Cloud Watch的混合方案可能是更为合适的方案。其中AWS生态中甚至都有现成的商业方案（例如，我很喜欢的Stack Drive3）。

## 自动部署

无论是原来的私有数据中心，还是现在的公有云，自动化部署都是任何商业系统不可缺少的一部分。它能够大大提高运维效率并且让开发工作更容易得到验证。因此，AWS为系统部署提供了多种选择并把它们定义为应用程序管理服务。这里，让我们首先看看AWS文档中这张示意图：

![管理服务图](/images/2014-07-10/management.png)

图2：AWS中的应用程序管理服务

就如上图所示，AWS为各种应用场景提供了不同的解决方案。由于针对的应用场景不同，这些服务的关注点也就不同。具体如下：

- AWS Elastic Beanstalk主要是为Web应用程序提供快速部署服务（有点类似国内SAE、BAE等服务），它帮助开发和运维隐藏了大量的底层细节，非常方便上手部署应用。但是，该服务在管理底层基础设施架构上就基本没有多少灵活性，无法适应项目的个性化需求。

- AWS OpsWorks是AWS的DevOps部署框架。它针对AWS上服务的常见架构设计了Stack和Layer等概念，并让用户灵活的把自己的整个技术栈和分层设计理念对应到这些概念中。而且它还帮助实现很多常见的自动化部署工作（如集成Auto Scaling逻辑）。它提供了比Beanstalk更多的灵活性和部署策略，但所支持的AWS服务和平台（目前只支持Linux）仍然有限。

- AWS Cloud Formation是AWS提供的资源管理自动化方案。它利用资源描述文件（JSON格式）来描述整个基础设施的架构，并在Provision整个基础设施过程过程中自动管理各种资源之间的依赖关系。Cloud Formation关注于支持、管理尽可能多的AWS资源自身，所以它非常强大、灵活。但是它对自动化部署中的一些基本操作（如代码自动更新等）支持偏弱，而且写出复杂的基础设施描述文件也并不容易（为此，AWS提供了很多模板）。

- AWS同样也提供了丰富的API和脚本库（如Python的boto、AWS CLI等），你也可以完全自己实现整个系统的自动化部署。

一般来说，如果需要在AWS上面部署一个新的应用，推荐的实践就是如图6从左向右依次选择，并且在确认左面的方案有明确限制的情况下再考虑下一个选择。如果图6中左边服务已经能够解决问题，就不建议自己开发相应的系统。毕竟整个部署系统的开发和维护还是需要一个不小的成本，而AWS提供的这些应用程序管理服务都免费的。另外，在绝大多数情况下，Cloud Formation已经足够灵活以满足你在AWS上部署服务。但是，在某些情况下（例如，同时支持在多个云服务提供商上部署服务），你可能还得选择完全自己开发或采用第三方供应商的方案。

最后，你可以参考[这篇文章](http://blog.xuguilin.me/2014/01/22/autodeploy-on-aws.html)了解我们团队在过去几年是怎样做AWS上的自动化部署工作。

## 成本控制

AWS一直定位于基础设施服务（IaaS）提供商，用户主要支付计算、存储、网络这三方面费用。对于绝大部分服务，计算都是这三者之中最大开销，所以如何控制计算成本就非常关键。我们可以利用下面的一些技巧来节省AWS的计算成本：

- 使用预留实例（Reserved Instance）。预留实例是AWS为那些愿意为EC2服务预付部分费用的客户推出的一项增值服务，它有很多明显优势：

- 提供非常大费用折扣。以M3的xlarge Linux实例美东数据中心的价格为例，一般的按需实例的价格为0.28美元/小时，如果你能够预付一年费用的话最高可以降到0.074美元/小时。

- 提供容量预留。用户能够确信在需要时可以启动预留数量的实例，而按需实例存在无足够实例可用的可能性（尽管很少发生，但是我们确实经历过）。

- 提供调整余地。用户可以在预留实例有效期内根据业务需要做一定的调整，如对同一类型的预留实例进行尺寸上的合并，把预留实例在同一区域下的不同AZ迁移。

- 不影响使用逻辑。预留实例与普通的按需实例在使用上完全一样，只是在记账的时使用预留实例价格。

实践当中，最常见的方式就是为最低配置购买预留实例（而且这也是你系统绝大部分时候的状态），对于突发流量所需要的额外EC2实例则可以使用按需实例。

- 充分使用你已付费实例的每一分钟：目前，AWS仍然按小时来计费，不足一个小时的使用时间按照一个小时付费。换句话说，你在一个小时内启动并关闭某一个实例两次，AWS会收两个小时的费用。为了避免这种额外的费用，需要尽量用足每一个小时。我们的实践就是当需要关闭一个实例时候，检查该实例的运行时间（可以利用EC2的Launch Time动态计算）是否接近小时的整数倍，调度算法只会关闭接近小时整数倍的实例。这样就可以在不增加费用的同时尽量避免反复启动实例以应对间歇性突发流量。但是，目前的Auto Scaling还不能支持这种调度策略，所以你可能需要自己实现这样的逻辑。

- 及时检查你的EC2成本。为了帮助客户控制、分析EC2的开销，AWS特意提供了一个EC2 Usage Report，你可以通过它：

	- 查询、分析各种维度的EC2成本。如不同数据中心、不同类型实例，不同Tag实例的成本开销。
	- 查询、分析预留实例使用情况，并根据目前利用率制定新的预留实例购买、修改计划。
	- 分析EC2实例的历史成本开销来预测未来的成本以做更好的财务计划。

- 购买企业级服务。如果你的公司需要大规模的使用EC2服务，建议购买企业级支持并使用Consolidated Billing方式支付费用，因为：

- 购买企业级支持后，除了可以得到更好的技术支持，你还能利用AWS的Trust Advisor给你的建议减少不必要的开销。根据AWS最新发布的消息，Trust Advisor已经帮助客户累计减少2亿美元不必要开销。

- Consolidated Billing付费方式可以让你用一个付款账户支付公司所有的AWS账户费用，并且能够跟踪公司所有账户的开销，方便整个公司的AWS成本预算。同时，Consolidated Billing还能够帮助我们更快的获得Volume Discount。例如，由于EC2的预留实例价格会随着整个费用的增加而单价逐渐降低，在用Consolidated Bill计算账单的时候会把所有账单的EC2实例费用累计后再计算价格。

- 试试Spot实例。从可用性角度来分类，EC2实例分成普通实例和Spot实例。其中普通实例就是用户主动申请使用、主动释放的实例。而Spot实例则是另外一种运行模式，用户可以通过竞价的方式来取得EC2实例资源，出价高的一方获得当前的实例。当有别人出价比你高的时候，别人就有可能取得你的计算资源（但是，你不用支付最后一个不满一个小时的实例费用）。由于这种资源可用性的限制，用户出价一般都会比普通实例的价格低很多（甚至只有正常三分之一的价格）。很显然，Spot实例非常适合用于非实时性处理任务，如后台批处理任务，离线的数据分析任务等。如果你的服务类型刚好适合这种实例，或者你的服务可以为Spot实例做特殊设计，这种方案将会大大降低EC2实例成本。AWS也分享了很多关于Spot实例的成功案例5，大家可以作为参考。

## 写在最后

作为AWS开发者，保持对AWS的关注非常重要。AWS是一个持续更新的平台，仅2013一年就有超过260次的重大功能更新。通过对AWS的关注可以帮助我们及时了解AWS最新的动态和新功能，这将帮助我们回顾现在的架构和实现是否仍然最合适。

目前，最简单的关注AWS的方法就是订阅AWS官方博客6。除此之外，AWS还有很多专题博客也非常值得关注，如关注于安全的AWS Security，关注于应用程序部署的AWS Application Management等，这些博客的链接都可以在AWS官方博客中找到。当然AWS中国的官方博客7和微博也是中文资料的不错来源。 